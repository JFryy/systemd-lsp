name: Rust

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build
      run: cargo build --verbose
    - name: Run tests
      run: cargo test --verbose

  build-nix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Build
        id: build
        continue-on-error: true
        uses: mathiasvr/command-output@v2.0.0
        with:
          run: nix build
      - name: Calculate cargoHash
        if: "contains(steps.build.outputs.stderr, 'ERROR: cargoHash or cargoSha256 is out of date')"
        run: |
          sed -i -E 's/cargoHash = ".+";/cargoHash = "";/g' flake.nix
          hash=$(nix build 2>&1 | sed -n -E 's/.*got: +([^ ]+).*/\1/p')
          line=$(awk '/cargoHash/ { print NR }' flake.nix)
          echo "::error file=flake.nix,line=$line,::cargoHash is out of date. Should be: $hash"
